[ホームに戻る](./index.md)  
←　[第４話](AnalogIn_explain.md)　｜　[第６話](comunication.md)　→  

# 割り込み処理を活用しよう
　今回の記事では、マイコンプログラミングにおいて重要な「割り込み処理」について説明します。あまり聞き馴染みのない言葉だとは思いますが、
**ステッピングモーターの回転**、**エンコーダーの利用**、**マイコン間通信**、**並行処理**など、様々なところで活用します。
　
　少しボリューミーになると思いますが、是非習得してください。

# 割り込み処理とは
　割り込みとは、「特定の条件のときに、平時の処理を中断して、別の処理（割り込み処理）を行う」というものです。Mbedでは、主に３種類の「条件」に対応する割り込み処理のクラスが存在しています。

* タイマー割り込み
* ピン変化割り込み
* 通信割り込み

の３種類です。この記事では前半２つを解説します。「通信割り込み」は通信の記事で取り扱うので [第６話](comunication.md) を参照してください。

# タイマー割り込み (Ticker)
　タイマー割り込みは、一定周期で処理を割り込ませることができます。ピンと来ないと思うので、早速以下のサンプルプログラムを作ってみましょう。
LEDを２つ、タクトスイッチを一つ用意して、一方は１秒周期で点滅、もう一方はボタンが押されるまで待機し、押されたら点灯するようなプログラムを作ります。
LEDに抵抗をつなげるのもお忘れなく‼

``` cpp
#include <mbed.h>

Ticker tick_sample;
DigitalOut myled1(PA_1);
DigitalOut myled2(PA_2);
DigitalIn my_sw(PA_0);

void warikomi()
{
    myled2 = !myled2;
    //点灯していたら(myled2.read()がtrue)、falseにする。逆も同様
}

int main()
{
    tick_sample.attach(&warikomi,500000);
    //下がメインの処理
    myled1.write(0);
    while(my_sw.read()){/*スイッチがHIGH(オフ)のとき無限ループ*/}
    myled1.write(1);
}

```

さて、想定通り動いたはずです。ここで重要なのは、**main関数内の処理が待機中であるにもかかわらず、点滅させることができている点です**。このように、タイマー割り込みは**並列で処理させたいとき**や、**最初から最後まで一定周期で処理を行いたいとき**に使用します。また、タイマー割り込みの仕様を理解した後だと
**コードがシンプルになる**というメリットもあります。

## Tickerの使い方
　Tickerの使い方を解説します。詳しく知りたい人は [こちら](https://os.mbed.com/docs/mbed-os/v6.15/mbed-os-api-doxy/classmbed_1_1_ticker.html)からレファレンスを読んでください。
　Tickerでは、n マイクロ秒ごとに関数を呼び出す、という形でタイマー割り込みを実行します。なので、予め割り込ませたい処理を関数にしておいてください。

``` cpp
Ticker tick_sample;
```
例によってインスタンス化です。特に言うことはないです。

``` cpp
tick_sample.attach(&warikomi,500000);
```
これでタイマー割り込みをセットします。このコードが読み込まれた後、タイマー割り込みが始まります。


←　[第４話](AnalogIn_explain.md)　｜　[第６話](comunication.md)　→  
[ホームに戻る](./index.md)